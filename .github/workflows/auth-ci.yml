name: ğŸ” Auth Reliability CI

on:
  # Run on PRs
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'tests/ci-auth/**'
      - '.github/workflows/auth-ci.yml'
  
  # Run on merges to main
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'tests/ci-auth/**'
  
  # Run on deployments (manually triggered)
  workflow_dispatch:
    inputs:
      create_baseline:
        description: 'Create new regression baseline'
        required: false
        default: 'false'
        type: boolean

env:
  # Backend environment
  DATABASE_URL: sqlite:///app/test_auth.db
  ADMIN_PRIVATE_KEY: ci-test-jwt-secret-key-for-github-actions
  
  # Frontend environment  
  NEXT_PUBLIC_API_BASE_URL: http://localhost:8080
  NEXT_PUBLIC_AUTH_MODE: cookie
  
  # Docker settings
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  auth-reliability-test:
    name: Authentication Reliability Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        phase: [
          { name: "Static Contract", command: "phase1" },
          { name: "Runtime Smoke", command: "phase2" }, 
          { name: "CORS Transport", command: "phase3" },
          { name: "Regression Snapshot", command: "phase4" }
        ]
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Need previous commit for comparison

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”§ Install Python Dependencies
      run: |
        pip install --upgrade pip
        pip install aiohttp docker pyyaml

    - name: ğŸ—ï¸ Build Docker Images
      run: |
        # Build backend image
        docker build -t ci-auth-backend:latest ./backend
        
        # Build frontend image  
        docker build -t ci-auth-frontend:latest ./frontend

    - name: ğŸ§ª Run ${{ matrix.phase.name }} Tests
      run: |
        cd tests/ci-auth
        
        # Create baseline if requested
        if [[ "${{ github.event.inputs.create_baseline }}" == "true" && "${{ matrix.phase.command }}" == "phase4" ]]; then
          ./run_auth_tests.sh ${{ matrix.phase.command }} --create-baseline
        else
          ./run_auth_tests.sh ${{ matrix.phase.command }}
        fi
      
    - name: ğŸ“Š Upload Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: auth-test-results-${{ matrix.phase.command }}
        path: |
          tests/ci-auth/snapshots/
          tests/ci-auth/*.log
        retention-days: 7

    - name: ğŸ“ Comment PR with Results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request' && failure()
      with:
        script: |
          const phase = '${{ matrix.phase.name }}';
          const body = `ğŸš¨ **Auth Reliability Test Failed: ${phase}**
          
          The authentication system has detected issues in the ${phase} phase.
          
          **What this means:**
          - Authentication may be broken or have regressions
          - This PR should not be merged until fixed
          
          **Next steps:**
          1. Check the detailed logs in the Actions tab
          2. Fix the identified issues
          3. Re-run the tests
          
          **Phase Details:**
          - **Static Contract**: Frontend/backend API mismatches or missing env vars
          - **Runtime Smoke**: End-to-end auth flow broken or services unreachable  
          - **CORS Transport**: Cross-origin issues or proxy routing problems
          - **Regression Snapshot**: Auth behavior has changed from baseline
          
          This is an automated comment from the Auth Reliability CI system.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

  # Combined results job
  auth-test-summary:
    name: ğŸ“‹ Auth Test Summary
    needs: auth-reliability-test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: test-results/
    
    - name: ğŸ“Š Generate Summary Report
      run: |
        echo "## ğŸ” Authentication Reliability Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        
        # Check each job result
        phases=("phase1:Static Contract" "phase2:Runtime Smoke" "phase3:CORS Transport" "phase4:Regression Snapshot")
        
        for phase_info in "${phases[@]}"; do
          IFS=':' read -r phase_id phase_name <<< "$phase_info"
          
          # This is a simplified check - in a real implementation you'd parse the actual results
          echo "| $phase_name | âœ… Completed |" >> $GITHUB_STEP_SUMMARY
        done
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ” What These Tests Validate" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Static Contract**: API endpoints match between frontend and backend" >> $GITHUB_STEP_SUMMARY
        echo "- **Runtime Smoke**: End-to-end login flow works in containerized environment" >> $GITHUB_STEP_SUMMARY
        echo "- **CORS Transport**: Cross-origin requests and proxy routing function correctly" >> $GITHUB_STEP_SUMMARY
        echo "- **Regression Snapshot**: Auth behavior hasn't changed from baseline" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ Artifacts Available" >> $GITHUB_STEP_SUMMARY
        echo "- Test result snapshots" >> $GITHUB_STEP_SUMMARY
        echo "- Comparison reports" >> $GITHUB_STEP_SUMMARY
        echo "- Debug logs" >> $GITHUB_STEP_SUMMARY

    - name: âœ… Mark as Success
      if: ${{ needs.auth-reliability-test.result == 'success' }}
      run: |
        echo "ğŸ‰ All authentication reliability tests passed!"
        echo "The auth system is verified to be working correctly."
    
    - name: âŒ Mark as Failure  
      if: ${{ needs.auth-reliability-test.result == 'failure' }}
      run: |
        echo "ğŸš¨ Authentication reliability tests failed!"
        echo "The auth system has regressions or configuration issues."
        exit 1

  # Deployment trigger (only on main branch)
  trigger-deployment:
    name: ğŸš€ Trigger Deployment
    needs: auth-test-summary
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && needs.auth-test-summary.result == 'success'
    
    steps:
    - name: ğŸ¯ Authentication Verified - Ready for Deployment
      run: |
        echo "âœ… Authentication system verified and ready for deployment"
        echo "All reliability checks passed - safe to deploy"
        
        # In a real implementation, you might trigger deployment here
        # For example:
        # curl -X POST $DEPLOYMENT_WEBHOOK_URL
        
    - name: ğŸ·ï¸ Tag Release
      if: github.event_name == 'push'
      uses: actions/github-script@v7
      with:
        script: |
          const tag = `auth-verified-${new Date().toISOString().split('T')[0]}-${context.sha.substring(0, 7)}`;
          
          github.rest.git.createRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: `refs/tags/${tag}`,
            sha: context.sha
          });
          
          core.info(`Created tag: ${tag}`);