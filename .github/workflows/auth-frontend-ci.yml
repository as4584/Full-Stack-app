name: üîê CI/CD - Auth Frontend Build & Deploy

on:
  push:
    branches: [main, feature/**]
    paths:
      - 'auth-frontend/**'
      - '.github/workflows/auth-frontend-ci.yml'
  pull_request:
    branches: [main]
    paths:
      - 'auth-frontend/**'

env:
  NODE_VERSION: '20.x'

jobs:
  # Job 1: Lint and Type Check
  lint-and-typecheck:
    name: üîç ESLint & TypeScript Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: auth-frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd auth-frontend
          npm ci

      - name: Run ESLint
        run: |
          cd auth-frontend
          npm run lint

      - name: TypeScript type check
        run: |
          cd auth-frontend
          npx tsc --noEmit

  # Job 2: Build Test (502 Prevention)
  build-test:
    name: üèóÔ∏è Build Test - No 502s Allowed
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: auth-frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd auth-frontend
          npm ci

      - name: Build application
        env:
          NEXT_PUBLIC_API_URL: https://receptionist.lexmakesit.com
        run: |
          cd auth-frontend
          npm run build

      - name: Verify build output
        run: |
          cd auth-frontend
          
          # Check .next directory exists
          if [ ! -d ".next" ]; then
            echo "‚ùå CRITICAL: Build failed - no .next directory!"
            exit 1
          fi
          
          # Check static files
          if [ ! -f "public/aero-background.js" ]; then
            echo "‚ùå CRITICAL: Missing aero-background.js!"
            exit 1
          fi
          
          echo "‚úÖ Build output verified"
          echo "üì¶ Build size:"
          du -sh .next/

      - name: Start production server
        run: |
          cd auth-frontend
          npm start &
          SERVER_PID=$!
          echo "Started server with PID: $SERVER_PID"
          sleep 10

      - name: Health check - No 502 errors
        run: |
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001)
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Auth frontend responding with 200 OK"
              break
            elif [ "$HTTP_CODE" = "502" ]; then
              echo "‚ùå CRITICAL: Auth frontend returns 502 Bad Gateway!"
              exit 1
            else
              echo "‚ö†Ô∏è  Attempt $((RETRY_COUNT+1)): Got HTTP $HTTP_CODE, retrying..."
              RETRY_COUNT=$((RETRY_COUNT+1))
              sleep 5
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "‚ùå Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi

      - name: Check auth routes
        run: |
          ROUTES=(
            "/signin"
            "/signup"
            "/forgot-password"
            "/verify"
          )
          
          for route in "${ROUTES[@]}"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001$route)
            
            if [ "$HTTP_CODE" = "502" ]; then
              echo "‚ùå CRITICAL: Route $route returns 502!"
              exit 1
            elif [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "307" ]; then
              echo "‚úÖ Route $route responsive (HTTP $HTTP_CODE)"
            fi
          done

      - name: Verify Frutiger Aero assets loaded
        run: |
          # Check if aero-background.js is served correctly
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/aero-background.js)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ aero-background.js loaded successfully"
          else
            echo "‚ùå CRITICAL: aero-background.js failed to load (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          # Check if CSS contains Frutiger Aero animations
          RESPONSE=$(curl -s http://localhost:3001/)
          if echo "$RESPONSE" | grep -q "aero-background"; then
            echo "‚úÖ Frutiger Aero CSS detected"
          else
            echo "‚ö†Ô∏è  Warning: Frutiger Aero CSS not found in HTML"
          fi

  # Job 3: Visual Test - Animated Background
  visual-test:
    name: üì∏ Visual Test - Frutiger Aero Animations
    runs-on: ubuntu-latest
    needs: [build-test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: auth-frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd auth-frontend
          npm ci
          npx playwright install --with-deps chromium

      - name: Build and start
        run: |
          cd auth-frontend
          npm run build
          npm start &
          sleep 10

      - name: Run visual checks
        run: |
          cd auth-frontend
          cat <<'EOF' > visual_check.js
          const { chromium } = require('playwright');
          
          (async () => {
            const browser = await chromium.launch();
            const context = await browser.newContext();
            const page = await context.newPage();
            
            console.log('üîç Testing auth frontend visual elements...');
            
            // Test signin page
            await page.goto('http://localhost:3001/signin');
            await page.waitForTimeout(2000);
            
            // Check if aero-background div exists
            const bgDiv = await page.$('.aero-background');
            if (!bgDiv) {
              console.error('‚ùå CRITICAL: .aero-background not found!');
              process.exit(1);
            }
            console.log('‚úÖ Background div present');
            
            // Check if bubbles were created
            const bubbles = await page.$$('.aero-bubble');
            if (bubbles.length === 0) {
              console.error('‚ùå CRITICAL: No animated bubbles found!');
              process.exit(1);
            }
            console.log(`‚úÖ Found ${bubbles.length} animated bubbles`);
            
            // Check if glass card is visible
            const card = await page.$('.glass-card');
            if (card) {
              const cardStyle = await card.evaluate(el => {
                const style = window.getComputedStyle(el);
                return {
                  backdropFilter: style.backdropFilter,
                  background: style.background
                };
              });
              console.log('‚úÖ Glass card styling:', cardStyle);
            }
            
            // Take screenshots
            await page.screenshot({ path: 'auth-signin.png', fullPage: true });
            
            // Test signup page
            await page.goto('http://localhost:3001/signup');
            await page.waitForTimeout(1000);
            await page.screenshot({ path: 'auth-signup.png', fullPage: true });
            
            console.log('‚úÖ All visual checks passed!');
            
            await browser.close();
          })();
          EOF
          
          node visual_check.js

      - name: Upload screenshots
        uses: actions/upload-artifact@v4
        with:
          name: auth-frontend-screenshots
          path: |
            auth-frontend/auth-signin.png
            auth-frontend/auth-signup.png

  # Job 4: Security Scan
  security-scan:
    name: üîí Security & Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run npm audit
        run: |
          cd auth-frontend
          npm audit --audit-level=moderate || true

  # Job 5: Deploy to Production
  deploy-production:
    name: üöÄ Deploy Auth Frontend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [build-test, visual-test, security-scan]
    environment:
      name: production-auth
      url: https://auth.lexmakesit.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          cd auth-frontend
          docker build -f Dockerfile.prod -t auth-frontend:latest .

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /opt/ai-receptionist/auth-frontend
            git pull origin main
            docker compose -f docker-compose.prod.yml down
            docker compose -f docker-compose.prod.yml up -d --build
            sleep 10
            
            # Post-deployment health check
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://auth.lexmakesit.com/signin)
            if [ "$HTTP_CODE" = "502" ]; then
              echo "‚ùå DEPLOYMENT FAILED: 502 detected!"
              docker compose -f docker-compose.prod.yml logs --tail=50
              exit 1
            else
              echo "‚úÖ Auth frontend deployed - HTTP $HTTP_CODE"
            fi

      - name: Verify animations in production
        run: |
          # Check if aero-background.js is accessible
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://auth.lexmakesit.com/aero-background.js)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Frutiger Aero animations active in production"
          else
            echo "‚ö†Ô∏è  Warning: Animation file HTTP $HTTP_CODE"
          fi

      - name: Success notification
        run: |
          echo "üéâ Auth frontend deployed successfully!"
          echo "üé® Frutiger Aero animated backgrounds active"
          echo "üîê URL: https://auth.lexmakesit.com"
