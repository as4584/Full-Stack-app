name: üß™ E2E Tests (Production)

# E2E tests run against production - manual trigger only
# These don't block PRs since they need production access
on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  e2e-health:
    name: üè• API Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check API Health
        run: |
          API_URL="${{ secrets.PROD_API_URL || 'https://api.lexmakesit.com' }}"
          echo "Checking $API_URL/health..."
          
          if curl -sf "$API_URL/health" --max-time 10; then
            echo "‚úÖ API is healthy"
          else
            echo "‚ö†Ô∏è API health check failed or timed out"
            exit 1
          fi

  e2e-integration:
    name: üåê Integration Tests
    runs-on: ubuntu-latest
    needs: e2e-health
    if: ${{ success() }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install test dependencies
        run: |
          pip install requests bcrypt
      
      - name: Run integration tests
        env:
          API_URL: ${{ secrets.PROD_API_URL || 'https://api.lexmakesit.com' }}
        run: |
          echo "Running integration tests against $API_URL"
          
          # Test public endpoints
          curl -sf "$API_URL/health" && echo "‚úÖ Health endpoint works"
          
          # Note: Full E2E tests require authentication secrets
          # Configure TEST_EMAIL and TEST_PASSWORD secrets to enable
          echo "‚ÑπÔ∏è Configure secrets for full E2E test coverage"
